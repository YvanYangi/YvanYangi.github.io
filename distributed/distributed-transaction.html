<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式事务解决数据一致性 | YangYangYang &#39;s Blog</title>
    <meta name="description" content="个人博客">
    <link rel="shortcut icon" href="/logo.png">
    
    <link rel="preload" href="/assets/css/styles.f683b4c6.css" as="style"><link rel="preload" href="/assets/js/app.f683b4c6.js" as="script"><link rel="preload" href="/assets/css/4.styles.50c27472.css" as="style"><link rel="preload" href="/assets/js/4.50c27472.js" as="script"><link rel="preload" href="/assets/css/0.styles.7d54da41.css" as="style"><link rel="preload" href="/assets/js/0.7d54da41.js" as="script"><link rel="preload" href="/assets/js/29.36146808.js" as="script"><link rel="prefetch" href="/assets/css/10.styles.82242ae5.css"><link rel="prefetch" href="/assets/css/12.styles.ac239c1a.css"><link rel="prefetch" href="/assets/css/13.styles.6d0d72ac.css"><link rel="prefetch" href="/assets/css/15.styles.a9d02288.css"><link rel="prefetch" href="/assets/css/16.styles.14f65a8d.css"><link rel="prefetch" href="/assets/css/17.styles.26c50035.css"><link rel="prefetch" href="/assets/css/18.styles.b0e60722.css"><link rel="prefetch" href="/assets/css/19.styles.8a06eb8d.css"><link rel="prefetch" href="/assets/css/2.styles.4691f751.css"><link rel="prefetch" href="/assets/css/20.styles.d5f5821a.css"><link rel="prefetch" href="/assets/css/21.styles.2c32c5a9.css"><link rel="prefetch" href="/assets/css/22.styles.dd37a877.css"><link rel="prefetch" href="/assets/css/23.styles.9c6e3f19.css"><link rel="prefetch" href="/assets/css/24.styles.ba0b5736.css"><link rel="prefetch" href="/assets/css/5.styles.eb0cf3ec.css"><link rel="prefetch" href="/assets/css/6.styles.3f72f639.css"><link rel="prefetch" href="/assets/css/7.styles.51367826.css"><link rel="prefetch" href="/assets/css/8.styles.df4e69a3.css"><link rel="prefetch" href="/assets/css/9.styles.13a61a09.css"><link rel="prefetch" href="/assets/js/10.82242ae5.js"><link rel="prefetch" href="/assets/js/11.31341d39.js"><link rel="prefetch" href="/assets/js/12.ac239c1a.js"><link rel="prefetch" href="/assets/js/13.6d0d72ac.js"><link rel="prefetch" href="/assets/js/14.77f430c4.js"><link rel="prefetch" href="/assets/js/15.a9d02288.js"><link rel="prefetch" href="/assets/js/16.14f65a8d.js"><link rel="prefetch" href="/assets/js/17.26c50035.js"><link rel="prefetch" href="/assets/js/18.b0e60722.js"><link rel="prefetch" href="/assets/js/19.8a06eb8d.js"><link rel="prefetch" href="/assets/js/20.d5f5821a.js"><link rel="prefetch" href="/assets/js/21.2c32c5a9.js"><link rel="prefetch" href="/assets/js/22.dd37a877.js"><link rel="prefetch" href="/assets/js/23.9c6e3f19.js"><link rel="prefetch" href="/assets/js/24.ba0b5736.js"><link rel="prefetch" href="/assets/js/25.cce36918.js"><link rel="prefetch" href="/assets/js/26.8dead230.js"><link rel="prefetch" href="/assets/js/27.025b8a9c.js"><link rel="prefetch" href="/assets/js/28.a2f04a72.js"><link rel="prefetch" href="/assets/js/30.9957db65.js"><link rel="prefetch" href="/assets/js/31.715a3053.js"><link rel="prefetch" href="/assets/js/32.133e49b5.js"><link rel="prefetch" href="/assets/js/33.adbd0b7b.js"><link rel="prefetch" href="/assets/js/34.8d6b989b.js"><link rel="prefetch" href="/assets/js/35.fe1e59eb.js"><link rel="prefetch" href="/assets/js/36.e3b4d1e2.js"><link rel="prefetch" href="/assets/js/37.d03b8ffc.js"><link rel="prefetch" href="/assets/js/38.114a0cc8.js"><link rel="prefetch" href="/assets/js/39.7c3619fd.js"><link rel="prefetch" href="/assets/js/5.eb0cf3ec.js"><link rel="prefetch" href="/assets/js/6.3f72f639.js"><link rel="prefetch" href="/assets/js/7.51367826.js"><link rel="prefetch" href="/assets/js/8.df4e69a3.js"><link rel="prefetch" href="/assets/js/9.13a61a09.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4691f751.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.45d55d38.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7d54da41.css"><link rel="stylesheet" href="/assets/css/10.styles.82242ae5.css"><link rel="stylesheet" href="/assets/css/12.styles.ac239c1a.css"><link rel="stylesheet" href="/assets/css/13.styles.6d0d72ac.css"><link rel="stylesheet" href="/assets/css/15.styles.a9d02288.css"><link rel="stylesheet" href="/assets/css/16.styles.14f65a8d.css"><link rel="stylesheet" href="/assets/css/17.styles.26c50035.css"><link rel="stylesheet" href="/assets/css/18.styles.b0e60722.css"><link rel="stylesheet" href="/assets/css/19.styles.8a06eb8d.css"><link rel="stylesheet" href="/assets/css/2.styles.4691f751.css"><link rel="stylesheet" href="/assets/css/20.styles.d5f5821a.css"><link rel="stylesheet" href="/assets/css/21.styles.2c32c5a9.css"><link rel="stylesheet" href="/assets/css/22.styles.dd37a877.css"><link rel="stylesheet" href="/assets/css/23.styles.9c6e3f19.css"><link rel="stylesheet" href="/assets/css/24.styles.ba0b5736.css"><link rel="stylesheet" href="/assets/css/4.styles.50c27472.css"><link rel="stylesheet" href="/assets/css/5.styles.eb0cf3ec.css"><link rel="stylesheet" href="/assets/css/6.styles.3f72f639.css"><link rel="stylesheet" href="/assets/css/7.styles.51367826.css"><link rel="stylesheet" href="/assets/css/8.styles.df4e69a3.css"><link rel="stylesheet" href="/assets/css/9.styles.13a61a09.css"><link rel="stylesheet" href="/assets/css/styles.f683b4c6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">YangYangYang 's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/home/home.html" class="sidebar-link">主页</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaGuide</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>分布式</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/distributed/distributed-transaction.html" class="active sidebar-link">分布式事务解决数据一致性</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>开发</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据库</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>版本控制</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>服务器</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="分布式事务解决数据一致性"><a href="#分布式事务解决数据一致性" aria-hidden="true" class="header-anchor">#</a> 分布式事务解决数据一致性</h1> <h4 id="示例解决方案1"><a href="#示例解决方案1" aria-hidden="true" class="header-anchor">#</a> 示例解决方案1</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span><span class="token punctuation">{</span>
	conn <span class="token operator">=</span> DriveManager<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>jdbc<span class="token operator">:</span>mysqlxxxxxxxx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  stmt <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">createStatement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">//数据库生成订单操作</span>
  stmt<span class="token punctuation">.</span><span class="token function">executeUpdate</span><span class="token punctuation">(</span><span class="token string">&quot;insert xx values xx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//生成发送的消息内容</span>
  MsgObject <span class="token function">MsgContent</span><span class="token punctuation">(</span>orderID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//发送消息</span>
  MQClient<span class="token punctuation">.</span><span class="token function">sendMsg</span><span class="token punctuation">(</span>MsgContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//事务提交</span>
  conn<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token comment">//操作不成功则回退</span>
    conn<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="存在的问题："><a href="#存在的问题：" aria-hidden="true" class="header-anchor">#</a> 存在的问题：</h4> <ul><li>当发送MQ时，超时或者无法判断MQ是否发送成功时，则无法保证一致性。</li> <li>如果MQ发送成功，但是DB提交失败，则消息已经发送出去了，无法保证一致性。</li></ul> <h3 id="分布式事务分类"><a href="#分布式事务分类" aria-hidden="true" class="header-anchor">#</a> 分布式事务分类</h3> <ul><li><p>刚性分布式事务</p> <ul><li><p>强一致性</p> <p>ACID=原子性（Atomicity）、一致性（Consistency）、<strong>隔离性</strong>（Lsolation）、持久性（Durability）</p></li> <li><p>XA模型</p></li></ul></li> <li><p>柔性分布式事务</p> <ul><li><p>最终一致性</p></li> <li><p>CAP、BASE理论</p> <p>CAP：分布式环境下P一定需要，CA权衡折中。</p> <p>BASE：</p> <pre><code>- Basically Available 基本可用
- Soft state 柔性状态
- Eventual consistency 最终一致性
</code></pre></li> <li><p>TCC模型</p></li> <li><p>Sage模型</p></li></ul></li></ul> <h3 id="xa模型"><a href="#xa模型" aria-hidden="true" class="header-anchor">#</a> XA模型</h3> <ul><li><p>XA模型由AP、RM、TM组成</p> <ul><li>应用程序（Application Program）：定义事务边界(定义事务开始和结束)并访问事务边界内的资源。</li> <li>资源管理器（Resouce Manager）：管理计算机共享的资源（数据库等）</li> <li>事务管理器（Transaction Manager）：负责管理全局事务，分配事务唯一标识，监控事务的执行进度，负责事务的提交，回滚，失败恢复等。</li></ul></li> <li><p>二阶段提交，是XA规范标准实现。</p></li> <li><p>过程：</p> <ul><li>TM发起prepare投票。</li> <li>RM都同意后，TM再发起commit。</li> <li>commit过程出现宕机等异常，节点服务重启后，根据XA recover再次进行commit补偿。</li></ul></li> <li><p>缺点：</p> <ul><li>同步阻塞模型</li> <li>数据库资源锁定时间很长</li> <li>全局锁（隔离级别串行化），并发低</li> <li>不适合长事务场景</li></ul></li></ul> <h3 id="tcc模型"><a href="#tcc模型" aria-hidden="true" class="header-anchor">#</a> TCC模型</h3> <ul><li>Try-Confirm-Cancel</li> <li>TCC模型完全交友业务实现，每个子业务都需要实现TCC接口。<strong>对业务侵入大；资源锁定交由业务方</strong></li> <li>Try：尝试执行业务，完成所有业务检查，预留必要的业务资源</li> <li>Confirm：真正执行业务，不再做业务检查</li> <li>Cancel：释放Try阶段预留的业务资源</li></ul> <h3 id="saga模型"><a href="#saga模型" aria-hidden="true" class="header-anchor">#</a> Saga模型</h3> <ul><li>把一个分布式事务拆分为多个本地事务，每个本地事务都有相应的执行模块和补偿模块(对应TCC中的Confirm和Cancel)。</li> <li>当Saga事务中任意一个本地事务出错时，可以通过调用相关的补偿方法恢复之前的事务，达到事务最终一致性。</li> <li>当每个子事务T1,T2…Tn都有对应的补偿定义C1,C2…<strong>Cn-1</strong> <ul><li>最佳情况T1,T2…Tn成功完成</li> <li>或者T1,T2…Tj，Cj-1…C2,c1，0&lt;j&lt;n得以完成。意思就是一旦有事务执行失败，就依次执行反向补偿。</li></ul></li> <li>隔离性
<ul><li>业务层控制并发
<ul><li>在应用层加锁</li> <li>应用层预先冻结资源</li></ul></li></ul></li> <li>恢复方式
<ul><li>向后恢复</li> <li>向前恢复</li></ul></li></ul> <h3 id="特性比较"><a href="#特性比较" aria-hidden="true" class="header-anchor">#</a> 特性比较</h3> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">刚性事务</th> <th style="text-align:center;">柔性事务</th></tr></thead> <tbody><tr><td style="text-align:center;">业务改造</td> <td style="text-align:center;">无</td> <td style="text-align:center;">有</td></tr> <tr><td style="text-align:center;">回滚</td> <td style="text-align:center;">支持</td> <td style="text-align:center;">实现补偿接口</td></tr> <tr><td style="text-align:center;">一致性</td> <td style="text-align:center;">强一致</td> <td style="text-align:center;">最终一致</td></tr> <tr><td style="text-align:center;">隔离性</td> <td style="text-align:center;">原生支持</td> <td style="text-align:center;">实现资源锁定接口</td></tr> <tr><td style="text-align:center;">并发性能</td> <td style="text-align:center;">严重衰退</td> <td style="text-align:center;">略微衰退</td></tr> <tr><td style="text-align:center;">适合场景</td> <td style="text-align:center;">短事务并发较低</td> <td style="text-align:center;">长事务高并发</td></tr></tbody></table> <h3 id="异步场景分布式事务设计"><a href="#异步场景分布式事务设计" aria-hidden="true" class="header-anchor">#</a> 异步场景分布式事务设计</h3> <h4 id="方案一：业务方提供本地操作成功回查功能"><a href="#方案一：业务方提供本地操作成功回查功能" aria-hidden="true" class="header-anchor">#</a> 方案一：业务方提供本地操作成功回查功能</h4> <ul><li>MQ分布式事务消息设计
<ul><li>MQ事务消息设计事务消息作为一种异步确保性事务，将两个事务分支通过MQ进行异步解耦，MQ事务消息的设计流程同样借鉴了两段提交理论</li> <li>1.事务发起方首先发送prepare消息到MQ</li> <li>2.在发送prepare消息成功后执行本地事务</li> <li>3.根据本地事务执行结果返回commit或者rollback</li> <li>4.如果消息是rollback，MQ将删除该prepare消息不进行下发，如果是commit消息，MQ将会消息发送给consumer段</li> <li>5.如果执行本地事务过程中，执行端挂掉，或者超时，MQ服务器端将不停的询问producer来获取事务状态（<strong>半消息状态</strong>）</li> <li>6.Consumer端的消费成功机制有MQ保证</li></ul></li></ul> <p><img src="/img/distributed/2.png" alt="1"></p> <ul><li><p>优点：</p> <ul><li>通用</li></ul></li> <li><p>缺点</p> <ul><li><p>业务方需要提供回查接口，业务侵入较大</p></li> <li><p>发送消息非幂等</p></li> <li><p>消费端需要处理幂等</p></li></ul></li></ul> <h4 id="方案二：本地事务消息表"><a href="#方案二：本地事务消息表" aria-hidden="true" class="header-anchor">#</a> 方案二：本地事务消息表</h4> <ul><li><p>​	本地操作和发送消息通过本地事务强一致性</p> <ul><li><p>本地事务操作表</p></li> <li><p>本地事务消息表</p> <ul><li>mqMessages(msgid，content，topic，status)</li></ul></li></ul></li></ul> <p><img src="/img/distributed/3.png" alt="3"></p> <ul><li>发送端消息不幂等
<ul><li>At least once</li> <li>Only once</li> <li>At more once</li></ul></li> <li>消费端处理消息幂等
<ul><li>分布式锁</li></ul></li> <li>T1-&gt;T2-&gt;T3
<ul><li>T1、T2成功，T3失败
<ul><li>记录错误日志</li> <li>报警</li> <li>人工介入</li></ul></li></ul></li> <li>优点
<ul><li>业务侵入小</li></ul></li></ul></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间: </span> <span class="time">6/24/2019, 9:34:23 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java-guide/cache.html" class="prev">
        缓存
      </a></span> <span class="next"><a href="/develop/debug.html">
        Debug
      </a>
      →
    </span></p></div>  <div id="gitalk-container" class="content default"></div></div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/4.50c27472.js" defer></script><script src="/assets/js/0.7d54da41.js" defer></script><script src="/assets/js/29.36146808.js" defer></script><script src="/assets/js/app.f683b4c6.js" defer></script>
  </body>
</html>
